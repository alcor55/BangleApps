<html>
  <head>
    <link rel="stylesheet" href="../../css/spectre.min.css">
    <style>
      input.offset {
          width: 80px;
      }
      input.name {
          width: 150px;
      }
    </style>
  </head>
  <body>    
    <table id="rows" class="table table-scroll">
      <tr>
        <th>Name</th>
        <th>Short Name</th>
        <th>UTC Offset</th>
      </tr>
    </table>

    <button id="addrow" class="btn">+</button>
    <button id="delrow" class="btn">-</button>
    <br><br><br>
    <button id="upload" class="btn btn-primary">Upload</button>
    <template id="row-template">
      <tr class="row">
        <td>
          <input type="text" class="name"></input>
        </td>
        <td>
          <input type="text" class="shortname"></input>
        </td>
        <td>
          <input type="number" class="offset"></input>
        </td>
      </tr>
    </template>

    <script src="../../core/lib/customize.js"></script>

    <script>
      let storedString = localStorage.getItem('worldclkinfo-config');
      let stored = {};
      if (storedString) {
        stored = JSON.parse(storedString);
      }

      if (!stored.rows) {
        stored.rows = [
          {
            name: "London",
            offset: 1,
          },
          {
            name: "Mumbai",
            offset: 5.5,
          },
          {
            name: "New York",
						shortname: "NYC",
            offset: -4,
          },
          {
            name: "Tokyo",
            offset: 9,
          },
          {
            name: "Dubai",
            offset: 4,
          },
          {
            name: "Los Angeles",
						shortname: "LA",
            offset: -7,
          },
          {
            name: "Paris",
            offset: 2,
          },
          {
            name: "Hong Kong",
						shortname: "HK",
            offset: 8,
          },
        ];
      }

      let tbl = document.getElementById("rows");
      let tmp = document.getElementById("row-template");
      for (let i = 0; i < stored.rows.length; i++) {
        let row = tmp.content.cloneNode(true);
        let storedRow = stored.rows[i]
        row.querySelector(".name").value = storedRow.name || "";
        row.querySelector(".shortname").value = storedRow.shortname || "";
        row.querySelector(".offset").value = storedRow.offset || "";
        tbl.append(row);
      }

      document.getElementById("addrow").addEventListener("click", function() {
        let tbl = document.getElementById("rows");
        let tmp = document.getElementById("row-template");
        let row = tmp.content.cloneNode(true);
        tbl.append(row);
      });

      document.getElementById("delrow").addEventListener("click", function() {
        let tbl = document.getElementById("rows");
        if (tbl.rows.length > 1) tbl.deleteRow(tbl.rows.length -1);
      });

      document.getElementById("upload").addEventListener("click", function() {
        let config = {
          rows: []
        };

        document.querySelectorAll(".row").forEach((row) => {
          let name = row.querySelector(".name").value;
          let shortname = row.querySelector(".shortname").value;
          let offset = row.querySelector(".offset").value;
          if ( name != "" && offset != "" ) {
            config.rows.push({
              name: name,
              shortname: shortname,
              offset: offset,
            });
          }
        });

        localStorage.setItem('worldclkinfo-config', JSON.stringify(config));

        // send finished app (in addition to contents of app.json)
        sendCustomizedApp({
          storage:[
            {
              name: "worldclkinfo.config.json",
              content: JSON.stringify(config)
            },
          ]
        });
      });
    </script>
  </body>
</html>
